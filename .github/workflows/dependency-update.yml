name: 🔄 Dependency Updates

on:
    schedule:
        # Run every Monday at 9 AM UTC
        - cron: '0 9 * * 1'
    workflow_dispatch:
    push:
        paths:
            - 'project/requirements.txt'
            - 'Dockerfile'
            - 'Dockerfile.dev'

permissions:
    contents: write
    pull-requests: write

jobs:
    update-dependencies:
        name: 🔄 Update Dependencies
        runs-on: ubuntu-latest

        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: 🐍 Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12"

            - name: 📦 Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r project/requirements.txt
                  pip install pip-audit safety

            - name: 🔍 Check for outdated packages
              run: |
                  cd project
                  pip list --outdated --format=json > outdated_packages.json
                  echo "Outdated packages found:"
                  cat outdated_packages.json

            - name: 🔒 Security audit
              run: |
                  cd project
                  pip-audit --format=json --output=audit_report.json
                  safety check --json --output=safety_report.json

            - name: 📊 Generate dependency report
              run: |
                  python -c "
                  import json
                  import os
                  
                  # Read outdated packages
                  with open('project/outdated_packages.json', 'r') as f:
                      outdated = json.load(f)
                  
                  # Read audit report
                  with open('project/audit_report.json', 'r') as f:
                      audit = json.load(f)
                  
                  # Read safety report
                  with open('project/safety_report.json', 'r') as f:
                      safety = json.load(f)
                  
                  # Generate summary
                  summary = {
                      'outdated_count': len(outdated),
                      'vulnerabilities': len(audit.get('vulnerabilities', [])),
                      'safety_issues': len(safety.get('vulnerabilities', [])),
                      'timestamp': os.popen('date -u +%Y-%m-%dT%H:%M:%SZ').read().strip()
                  }
                  
                  with open('dependency_summary.json', 'w') as f:
                      json.dump(summary, f, indent=2)
                  
                  print('Dependency Summary:')
                  print(json.dumps(summary, indent=2))
                  "

            - name: 📝 Create issue if vulnerabilities found
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const summary = JSON.parse(fs.readFileSync('dependency_summary.json', 'utf8'));
                      
                      if (summary.vulnerabilities > 0 || summary.safety_issues > 0) {
                          await github.rest.issues.create({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              title: `🚨 Security vulnerabilities detected in dependencies`,
                              body: `## Security Alert
                              
                              **Vulnerabilities found:**
                              - pip-audit: ${summary.vulnerabilities} issues
                              - safety: ${summary.safety_issues} issues
                              
                              **Outdated packages:** ${summary.outdated_count}
                              
                              Please review and update dependencies to resolve security issues.
                              
                              Generated on: ${summary.timestamp}`,
                              labels: ['security', 'dependencies', 'urgent']
                          });
                      }

            - name: 📤 Upload reports
              uses: actions/upload-artifact@v4
              with:
                  name: dependency-reports
                  path: |
                      project/outdated_packages.json
                      project/audit_report.json
                      project/safety_report.json
                      dependency_summary.json
