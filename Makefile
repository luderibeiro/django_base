# Django Base - Makefile para Automa√ß√£o de Tarefas
# Template Django com Arquitetura Limpa

.PHONY: help setup install test run clean docker-build docker-run docker-stop migrate createsuperuser lint format security-check docs-serve docs-build

# Vari√°veis
PYTHON := python3
PIP := pip
VENV := venv
PROJECT_DIR := project
REQUIREMENTS := $(PROJECT_DIR)/requirements.txt
PYTEST := pytest
MANAGE := $(PYTHON) manage.py

# Cores para output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

# Help
help: ## Mostra esta mensagem de ajuda
	@echo "$(BLUE)Django Base - Template com Arquitetura Limpa$(NC)"
	@echo "$(YELLOW)Comandos dispon√≠veis:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Setup inicial
setup: ## Configura o ambiente de desenvolvimento completo
	@echo "$(BLUE)üöÄ Configurando ambiente de desenvolvimento...$(NC)"
	@$(MAKE) install
	@$(MAKE) migrate
	@$(MAKE) createsuperuser
	@echo "$(GREEN)‚úÖ Ambiente configurado com sucesso!$(NC)"
	@echo "$(YELLOW)üí° Execute 'make run' para iniciar o servidor$(NC)"

# Instala√ß√£o de depend√™ncias
install: ## Instala todas as depend√™ncias
	@echo "$(BLUE)üì¶ Instalando depend√™ncias...$(NC)"
	@if [ ! -d "$(VENV)" ]; then \
		echo "$(YELLOW)üìÅ Criando ambiente virtual...$(NC)"; \
		$(PYTHON) -m venv $(VENV); \
	fi
	@echo "$(YELLOW)üîÑ Ativando ambiente virtual...$(NC)"
	@. $(VENV)/bin/activate && $(PIP) install --upgrade pip
	@. $(VENV)/bin/activate && $(PIP) install -r $(REQUIREMENTS)
	@echo "$(GREEN)‚úÖ Depend√™ncias instaladas com sucesso!$(NC)"

# Testes
test: ## Executa todos os testes
	@echo "$(BLUE)üß™ Executando testes...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && export PYTHONPATH=$$PWD && $(PYTEST) -c ../config/pytest.ini -v
	@echo "$(GREEN)‚úÖ Testes executados com sucesso!$(NC)"

test-coverage: ## Executa testes com cobertura
	@echo "$(BLUE)üß™ Executando testes com cobertura...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && export PYTHONPATH=$$PWD && $(PYTEST) -c ../config/pytest.ini --cov=. --cov-config=../.coveragerc --cov-report=term-missing --cov-report=html
	@echo "$(GREEN)‚úÖ Relat√≥rio de cobertura gerado em htmlcov/$(NC)"

test-watch: ## Executa testes em modo watch
	@echo "$(BLUE)üß™ Executando testes em modo watch...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && export PYTHONPATH=$$PWD && $(PYTEST) -c ../config/pytest.ini -f

# Servidor de desenvolvimento
run: ## Inicia o servidor de desenvolvimento
	@echo "$(BLUE)üöÄ Iniciando servidor de desenvolvimento...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) runserver
	@echo "$(GREEN)‚úÖ Servidor iniciado em http://127.0.0.1:8000$(NC)"

run-prod: ## Inicia o servidor em modo produ√ß√£o
	@echo "$(BLUE)üöÄ Iniciando servidor em modo produ√ß√£o...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) runserver 0.0.0.0:8000

# Banco de dados
migrate: ## Executa migra√ß√µes do banco de dados
	@echo "$(BLUE)üóÑÔ∏è Executando migra√ß√µes...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) migrate
	@echo "$(GREEN)‚úÖ Migra√ß√µes executadas com sucesso!$(NC)"

makemigrations: ## Cria novas migra√ß√µes
	@echo "$(BLUE)üìù Criando migra√ß√µes...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) makemigrations
	@echo "$(GREEN)‚úÖ Migra√ß√µes criadas com sucesso!$(NC)"

createsuperuser: ## Cria um superusu√°rio
	@echo "$(BLUE)üë§ Criando superusu√°rio...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) createsuperuser
	@echo "$(GREEN)‚úÖ Superusu√°rio criado com sucesso!$(NC)"

# Limpeza
clean: ## Limpa arquivos tempor√°rios e cache
	@echo "$(BLUE)üßπ Limpando arquivos tempor√°rios...$(NC)"
	@find . -type f -name "*.pyc" -delete
	@find . -type d -name "__pycache__" -delete
	@find . -type d -name "*.egg-info" -exec rm -rf {} +
	@find . -type d -name ".pytest_cache" -exec rm -rf {} +
	@rm -rf htmlcov/
	@rm -rf .coverage
	@echo "$(GREEN)‚úÖ Limpeza conclu√≠da!$(NC)"

clean-all: clean ## Limpa tudo incluindo ambiente virtual
	@echo "$(BLUE)üßπ Limpando ambiente virtual...$(NC)"
	@rm -rf $(VENV)
	@echo "$(GREEN)‚úÖ Limpeza completa conclu√≠da!$(NC)"

# Docker
docker-build: ## Constr√≥i a imagem Docker (produ√ß√£o)
	@echo "$(BLUE)üê≥ Construindo imagem Docker de produ√ß√£o...$(NC)"
	@docker build -f docker/Dockerfile -t django-base:latest .
	@echo "$(GREEN)‚úÖ Imagem Docker constru√≠da com sucesso!$(NC)"

docker-build-dev: ## Constr√≥i a imagem Docker de desenvolvimento (mais r√°pida)
	@echo "$(BLUE)üê≥ Construindo imagem Docker de desenvolvimento...$(NC)"
	@docker build -f docker/Dockerfile.dev -t django-base:dev .
	@echo "$(GREEN)‚úÖ Imagem Docker de desenvolvimento constru√≠da!$(NC)"

docker-build-fast: ## Build r√°pido usando cache (apenas mudan√ßas de c√≥digo)
	@echo "$(BLUE)‚ö° Build r√°pido com cache...$(NC)"
	@docker build --cache-from django-base:latest -f docker/Dockerfile -t django-base:latest .
	@echo "$(GREEN)‚úÖ Build r√°pido conclu√≠do!$(NC)"

docker-run: ## Executa o container Docker
	@echo "$(BLUE)üê≥ Executando container Docker...$(NC)"
	@docker-compose -f docker/docker-compose.dev.yml up --build
	@echo "$(GREEN)‚úÖ Container Docker executando!$(NC)"

docker-run-dev: ## Executa container de desenvolvimento (mais r√°pido)
	@echo "$(BLUE)üê≥ Iniciando container de desenvolvimento...$(NC)"
	@docker run --rm -p 8000:8000 -v $(PWD)/project:/app/project django-base:dev
	@echo "$(GREEN)‚úÖ Container de desenvolvimento executando!$(NC)"

docker-stop: ## Para o container Docker
	@echo "$(BLUE)üê≥ Parando container Docker...$(NC)"
	@docker-compose -f docker/docker-compose.dev.yml down
	@echo "$(GREEN)‚úÖ Container Docker parado!$(NC)"

docker-clean: ## Limpa imagens e containers n√£o utilizados
	@echo "$(BLUE)üßπ Limpando Docker...$(NC)"
	@docker system prune -f
	@docker image prune -f
	@echo "$(GREEN)‚úÖ Limpeza conclu√≠da!$(NC)"

docker-prod: ## Executa em modo produ√ß√£o com Docker
	@echo "$(BLUE)üê≥ Executando em modo produ√ß√£o...$(NC)"
	@docker-compose -f docker/docker-compose.prod.yml up --build -d
	@echo "$(GREEN)‚úÖ Aplica√ß√£o rodando em produ√ß√£o!$(NC)"

# Qualidade de c√≥digo
lint: ## Executa linting no c√≥digo
	@echo "$(BLUE)üîç Executando linting...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && flake8 . --exclude=migrations,venv,__pycache__
	@echo "$(GREEN)‚úÖ Linting conclu√≠do!$(NC)"

docstyle: ## Verifica docstrings com pydocstyle
	@echo "$(BLUE)üìñ Verificando docstrings (pydocstyle)...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && pydocstyle core --config=../config/pydocstyle.ini || true
	@echo "$(GREEN)‚úÖ Verifica√ß√£o de docstrings conclu√≠da!$(NC)"

docs-quality: ## Formata e verifica documenta√ß√£o de c√≥digo (Black + pydocstyle)
	@echo "$(BLUE)üßπ Formatando e verificando documenta√ß√£o...$(NC)"
	@$(MAKE) format
	@$(MAKE) docstyle
	@echo "$(GREEN)‚úÖ Documenta√ß√£o de c√≥digo revisada!$(NC)"

format: ## Formata o c√≥digo
	@echo "$(BLUE)üé® Formatando c√≥digo...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && black . --exclude=migrations
	@echo "$(GREEN)‚úÖ C√≥digo formatado!$(NC)"

security-check: ## Verifica vulnerabilidades de seguran√ßa
	@echo "$(BLUE)üîí Verificando vulnerabilidades...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && pip-audit
	@echo "$(GREEN)‚úÖ Verifica√ß√£o de seguran√ßa conclu√≠da!$(NC)"

# Documenta√ß√£o
docs-serve: ## Serve a documenta√ß√£o localmente
	@echo "$(BLUE)üìö Servindo documenta√ß√£o...$(NC)"
	@mkdocs serve
	@echo "$(GREEN)‚úÖ Documenta√ß√£o dispon√≠vel em http://127.0.0.1:8000$(NC)"

docs-build: ## Constr√≥i a documenta√ß√£o
	@echo "$(BLUE)üìö Construindo documenta√ß√£o...$(NC)"
	@mkdocs build
	@echo "$(GREEN)‚úÖ Documenta√ß√£o constru√≠da em site/$(NC)"

docs-check: ## Valida documenta√ß√£o em modo estrito
	@echo "$(BLUE)üìö Validando documenta√ß√£o (strict)...$(NC)"
	@mkdocs build --strict
	@echo "$(GREEN)‚úÖ Documenta√ß√£o v√°lida (sem links quebrados)!$(NC)"

type-check: ## Executa verifica√ß√£o de tipos com mypy
	@echo "$(BLUE)üîç Verificando tipos (mypy)...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && mypy --config-file=../config/mypy.ini core/
	@echo "$(GREEN)‚úÖ Verifica√ß√£o de tipos conclu√≠da!$(NC)"

pre-commit-install: ## Instala hooks do pre-commit
	@echo "$(BLUE)üîß Instalando hooks do pre-commit...$(NC)"
	@. $(VENV)/bin/activate && pre-commit install
	@echo "$(GREEN)‚úÖ Hooks do pre-commit instalados!$(NC)"

pre-commit-run: ## Executa pre-commit em todos os arquivos
	@echo "$(BLUE)üîß Executando pre-commit...$(NC)"
	@. $(VENV)/bin/activate && pre-commit run --all-files
	@echo "$(GREEN)‚úÖ Pre-commit executado!$(NC)"

docs-deploy: ## Faz deploy da documenta√ß√£o
	@echo "$(BLUE)üìö Fazendo deploy da documenta√ß√£o...$(NC)"
	@mkdocs gh-deploy
	@echo "$(GREEN)‚úÖ Documenta√ß√£o deployada!$(NC)"

# Utilit√°rios
shell: ## Abre o shell do Django
	@echo "$(BLUE)üêç Abrindo shell do Django...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) shell

collectstatic: ## Coleta arquivos est√°ticos
	@echo "$(BLUE)üìÅ Coletando arquivos est√°ticos...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) collectstatic --noinput
	@echo "$(GREEN)‚úÖ Arquivos est√°ticos coletados!$(NC)"

check: ## Executa verifica√ß√µes do Django
	@echo "$(BLUE)üîç Executando verifica√ß√µes do Django...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && $(MANAGE) check
	@echo "$(GREEN)‚úÖ Verifica√ß√µes conclu√≠das!$(NC)"

# Desenvolvimento
dev-setup: ## Setup completo para desenvolvimento
	@echo "$(BLUE)üõ†Ô∏è Configurando ambiente de desenvolvimento...$(NC)"
	@$(MAKE) install
	@$(MAKE) migrate
	@$(MAKE) createsuperuser
	@$(MAKE) test
	@echo "$(GREEN)‚úÖ Ambiente de desenvolvimento configurado!$(NC)"
	@echo "$(YELLOW)üí° Execute 'make run' para iniciar o servidor$(NC)"

# Produ√ß√£o
prod-setup: ## Setup para produ√ß√£o
	@echo "$(BLUE)üöÄ Configurando ambiente de produ√ß√£o...$(NC)"
	@$(MAKE) install
	@$(MAKE) migrate
	@$(MAKE) collectstatic
	@$(MAKE) test
	@echo "$(GREEN)‚úÖ Ambiente de produ√ß√£o configurado!$(NC)"

# Status
status: ## Mostra o status do projeto
	@echo "$(BLUE)üìä Status do Projeto Django Base$(NC)"
	@echo "$(YELLOW)Python:$(NC) $$(python3 --version)"
	@echo "$(YELLOW)Django:$(NC) $$(cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && python -c 'import django; print(django.get_version())')"
	@echo "$(YELLOW)Testes:$(NC) $$(cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && export PYTHONPATH=$$PWD && pytest --tb=no -q | tail -1)"
	@echo "$(YELLOW)Ambiente Virtual:$(NC) $$(if [ -d "$(VENV)" ]; then echo "‚úÖ Ativo"; else echo "‚ùå N√£o encontrado"; fi)"
	@echo "$(YELLOW)Banco de Dados:$(NC) $$(cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && python manage.py check --database default 2>/dev/null && echo "‚úÖ OK" || echo "‚ùå Erro")"

# Git e Deploy
git-setup: ## Configura reposit√≥rio Git inicial
	@echo "$(BLUE)üîß Configurando reposit√≥rio Git...$(NC)"
	@git init
	@git add .
	@git commit -m "üéâ Initial commit: Django Base template setup"
	@echo "$(GREEN)‚úÖ Reposit√≥rio Git configurado!$(NC)"
	@echo "$(YELLOW)üí° Para conectar ao GitHub:$(NC)"
	@echo "$(YELLOW)   git remote add origin https://github.com/seu-usuario/seu-repo.git$(NC)"
	@echo "$(YELLOW)   git push -u origin main$(NC)"

git-commit: ## Faz commit com mensagem autom√°tica
	@echo "$(BLUE)üìù Fazendo commit das altera√ß√µes...$(NC)"
	@git add .
	@read -p "Digite a mensagem do commit: " msg; \
	git commit -m "$$msg"
	@echo "$(GREEN)‚úÖ Commit realizado!$(NC)"

git-push: ## Push para reposit√≥rio remoto
	@echo "$(BLUE)üöÄ Enviando altera√ß√µes para reposit√≥rio remoto...$(NC)"
	@git push
	@echo "$(GREEN)‚úÖ Altera√ß√µes enviadas!$(NC)"

# Backup e Restore
backup-db: ## Faz backup do banco de dados
	@echo "$(BLUE)üíæ Fazendo backup do banco de dados...$(NC)"
	@mkdir -p backups
	@cp $(PROJECT_DIR)/db.sqlite3 backups/db_backup_$$(date +%Y%m%d_%H%M%S).sqlite3
	@echo "$(GREEN)‚úÖ Backup criado em backups/$(NC)"

restore-db: ## Restaura backup do banco de dados
	@echo "$(BLUE)üîÑ Restaurando backup do banco de dados...$(NC)"
	@ls -la backups/
	@read -p "Digite o nome do arquivo de backup: " backup; \
	cp backups/$$backup $(PROJECT_DIR)/db.sqlite3
	@echo "$(GREEN)‚úÖ Banco de dados restaurado!$(NC)"

# An√°lise e Relat√≥rios
analyze: ## An√°lise completa do c√≥digo
	@echo "$(BLUE)üîç Executando an√°lise completa do c√≥digo...$(NC)"
	@$(MAKE) lint
	@$(MAKE) docstyle
	@$(MAKE) type-check
	@$(MAKE) security-check
	@$(MAKE) test-coverage
	@echo "$(GREEN)‚úÖ An√°lise completa conclu√≠da!$(NC)"

report: ## Gera relat√≥rio completo do projeto
	@echo "$(BLUE)üìä Gerando relat√≥rio do projeto...$(NC)"
	@echo "# Relat√≥rio do Projeto Django Base" > project_report.md
	@echo "Gerado em: $$(date)" >> project_report.md
	@echo "" >> project_report.md
	@echo "## Status do Projeto" >> project_report.md
	@$(MAKE) status >> project_report.md 2>&1
	@echo "" >> project_report.md
	@echo "## Estrutura de Arquivos" >> project_report.md
	@find $(PROJECT_DIR) -name "*.py" | head -20 >> project_report.md
	@echo "$(GREEN)‚úÖ Relat√≥rio gerado em project_report.md$(NC)"

# Utilit√°rios avan√ßados
requirements-update: ## Atualiza requirements.txt
	@echo "$(BLUE)üì¶ Atualizando requirements.txt...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && pip freeze > requirements.txt
	@echo "$(GREEN)‚úÖ Requirements atualizados!$(NC)"

requirements-check: ## Verifica depend√™ncias desatualizadas
	@echo "$(BLUE)üîç Verificando depend√™ncias desatualizadas...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && pip list --outdated
	@echo "$(GREEN)‚úÖ Verifica√ß√£o conclu√≠da!$(NC)"

env-example: ## Cria arquivo .env de exemplo
	@echo "$(BLUE)üìù Criando arquivo .env de exemplo...$(NC)"
	@echo "# Configura√ß√µes do Django" > .env.example
	@echo "DJANGO_DEBUG=True" >> .env.example
	@echo "DJANGO_SECRET_KEY=change-me-in-production" >> .env.example
	@echo "DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1" >> .env.example
	@echo "# Banco de dados (produ√ß√£o)" >> .env.example
	@echo "DB_ENGINE=django.db.backends.postgresql" >> .env.example
	@echo "DB_NAME=postgres" >> .env.example
	@echo "DB_USER=postgres" >> .env.example
	@echo "DB_PASSWORD=postgres" >> .env.example
	@echo "DB_HOST=project_db" >> .env.example
	@echo "DB_PORT=5432" >> .env.example
	@echo "# DRF" >> .env.example
	@echo "DRF_PAGE_SIZE=50" >> .env.example
	@echo "$(GREEN)‚úÖ Arquivo .env.example criado!$(NC)"

# Performance e Monitoramento
performance-test: ## Executa testes de performance
	@echo "$(BLUE)‚ö° Executando testes de performance...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && python manage.py test --settings=project.settings --keepdb --parallel
	@echo "$(GREEN)‚úÖ Testes de performance conclu√≠dos!$(NC)"

memory-profile: ## An√°lise de uso de mem√≥ria
	@echo "$(BLUE)üß† Analisando uso de mem√≥ria...$(NC)"
	@cd $(PROJECT_DIR) && . ../$(VENV)/bin/activate && python -m memory_profiler manage.py check
	@echo "$(GREEN)‚úÖ An√°lise de mem√≥ria conclu√≠da!$(NC)"

# Automa√ß√£o completa
full-setup: ## Setup completo com todas as verifica√ß√µes
	@echo "$(BLUE)üöÄ Executando setup completo...$(NC)"
	@$(MAKE) clean-all
	@$(MAKE) install
	@$(MAKE) migrate
	@$(MAKE) createsuperuser
	@$(MAKE) test
	@$(MAKE) lint
	@$(MAKE) docs-build
	@echo "$(GREEN)‚úÖ Setup completo finalizado!$(NC)"
	@echo "$(YELLOW)üí° Projeto pronto para desenvolvimento!$(NC)"

ci-pipeline: ## Pipeline de CI/CD completo
	@echo "$(BLUE)üîÑ Executando pipeline CI/CD...$(NC)"
	@$(MAKE) install
	@$(MAKE) lint
	@$(MAKE) docstyle
	@$(MAKE) type-check
	@$(MAKE) security-check
	@$(MAKE) test-coverage
	@$(MAKE) docs-build
	@echo "$(GREEN)‚úÖ Pipeline CI/CD conclu√≠do!$(NC)"

# Default target
.DEFAULT_GOAL := help
